<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Calendar</title>
<!--  <script src="calendarEx.js"></script>-->
  <style>
    thead th{border-bottom: 1px solid red}
    td{ padding: 5px;}
    .beforeMonth, .nextMonth{ color: gray;}
    .week{background-color: whitesmoke}
    .sun{background-color: bisque}
    .sat{background-color: lightblue}
    .today{font-weight: bold}
    .controller{
      display: flex;
      justify-content: space-between;
    }
    .controller-item{flex-wrap: wrap}
  </style>

</head>
<body>


  <div class="controller">
    <div class="controller-item">
      <button>before</button>
    </div>
    <div class="controller-item">
      <button>next</button>
    </div>
  </div>

  <div id="cal"></div>
</body>
<script>
  'use strict';
  Date.prototype.getWeek = function () {
    return  Math.ceil( (this.getDate() + new Date(this.getFullYear(),this.getMonth(),1).getDay()) / Date.length);
  }
  Date.prototype.getFullMonth = function () {
    return (this.getMonth() + 1);
  }
  Date.prototype.getLastDate = function () {
    // console.log('getLastDayStart',this.toLocaleDateString())
    let temp = new Date(this.getFullYear(), this.getMonth(), this.getDate());
    let nextMonth = new Date(this.getFullYear(),this.getMonth()+1,1);
    let lastDate;
    for ( let i = this.getDate(); temp.getTime() < nextMonth.getTime(); i++) {
      temp.setDate(i);
      lastDate = i;
      if (this.getMonth() < temp.getMonth() && temp.getDate() == 1){
        // console.log('break',temp.toLocaleDateString())
        break;
      }
      // console.log('for-temp',i,temp.toLocaleDateString())
    }
    // console.log(this.toLocaleDateString(),'=lastDate:',lastDate-1)
    return lastDate-1;
  }
  Date.prototype.getLastDay = function () {
    let temp = new Date(this.getFullYear(), this.getMonth(), this.getDate());
    let nextMonth = new Date(this.getFullYear(),this.getMonth()+1,1);
    let lastDate;
    for ( let i = this.getDate(); temp.getTime() < nextMonth.getTime(); i++) {

      if (this.getMonth() < temp.getMonth() && temp.getDate() == 1){
        console.log('break',temp.toLocaleDateString())
        break;
      }
      temp.setDate(i);
      lastDate = i-1;
      // console.log('for-temp',i,temp.toLocaleDateString())
    }
    temp = new Date(this.getFullYear(),this.getMonth(),lastDate);
    return temp.getDay();
  }
  Date.prototype.getDayOfWeek = function () {
    switch (this.getDay()) {
      case 0 : return "일";
      case 1 : return "월";
      case 2 : return "화";
      case 3 : return "수";
      case 4 : return "목";
      case 5 : return "금";
      case 6 : return "토";
    }
  }


  window.onload = function () {
    calendarEx.builder('#cal','2022-02-06');
    // render('#cal','2022-02-06');
  }


  class Day {

    /**
     *
     * @param {Date} day
     * @param {Object} info
     */
    constructor(day, info) {
      this.day = day;
      this.info = info;
    }
  }


  let calendarEx = {



    builder : function (el,dateString){

      let dt = new Date(dateString);
      let dates = new Array();
      //현재 월의 시작일이 일요일이 아닌경우 앞에 이전달의 요일을 추가
      let beforeMonth = new Date(dt.getFullYear(),dt.getMonth(),dt.getDate());
      // console.log('beforeMonth',beforeMonth.toLocaleDateString(), 'lastDate',beforeMonth.getLastDate())
      beforeMonth.setMonth(beforeMonth.getMonth()-1);//전달로 설정
      // console.log('beforeMonth',beforeMonth.toLocaleDateString(), 'lastDate',beforeMonth.getLastDate())

      //전달의 마지막 주의 첫 요일
      let firstDayOfBoforeMonth = new Date(beforeMonth.getFullYear(),beforeMonth.getMonth(),
        (beforeMonth.getLastDate() - beforeMonth.getLastDay()));
      // console.log('firstDayOfBoforeMonth',firstDayOfBoforeMonth.toLocaleDateString(),'firstday:',firstDayOfBoforeMonth.getDay())
      //캘린더 중 전달 정보를 저장
      for (let date = firstDayOfBoforeMonth.getDate(); date <= beforeMonth.getLastDate() ; date++) {
        let info = {
          week : 1,
          monthFlag : 'beforeMonth'
        };

        dates.push(new Day(new Date(beforeMonth.getFullYear(), beforeMonth.getMonth(), date),info));
      }
      // console.log('dates',dates);
      //캘린더 중 현재 달 정보를 저장
      for (let date = 1; date <= dt.getLastDate(); date++) {
        let currentDay = new Date(dt.getFullYear(), dt.getMonth(), date);
        let info = {
          week : currentDay.getWeek(),
          monthFlag : 'currentMonth'
        };


        dates.push(new Day(currentDay, info) );
        //마지막날이 토요일이 아닌경우 토요일까지만 다음달의 일자를 추가함
        if (date == dt.getLastDate() && dt.getLastDay() < 6){

          for (let dateOfNextMonth = 1; dateOfNextMonth <= 6 ; dateOfNextMonth++) {
            let nextMonth = new Date(dt.getFullYear(),dt.getMonth()+1, dateOfNextMonth);
            if (nextMonth.getDay() > dt.getLastDay() ){
              let info = {
                week : currentDay.getWeek(),
                monthFlag : 'nextMonth'
              };
              dates.push(new Day(new Date(nextMonth.getFullYear(), nextMonth.getMonth(), dateOfNextMonth),info));
            }
          }
        }
      }
      console.log('dates',dates);
      this._render(dates);
    },


    _render : function (dates){

      let table = document.createElement('table');
      let thead = document.createElement('thead');
      let tbody = document.createElement('tbody');
      let trInthead = document.createElement('tr');
      table.append(thead);
      table.append(tbody);


      //tbody
      let tr;
      for (const day of dates) {
        if (day.day.getDay() == 0){
          tr = document.createElement('tr')
        }
        if (day.info.week == 1){
          let th = document.createElement('th');
          th.textContent = day.day.getDayOfWeek();
          trInthead.append(th);

        }

        let td = document.createElement('td');
        setTitle : {
          let div = document.createElement('div');
          div.textContent = day.day.getDate();
          switch (day.day.getDayOfWeek()) {
            case '일' :
              div.className += 'sun';
              break;
            case '토' :
              div.className +='sat';
              break;
            default :
              div.className += 'week';
              break;
          }
          td.append(div);
        }

        setDayInfo : {
          //today
          if (day.day.getDate() == new Date().getDate()){
            td.className += ' today ';
          }
          td.className += day.info.monthFlag;
          //info 안에 들어있는 정보들을 td안에 추가
          for (const infoKey in day.info) {
            let div = document.createElement('div');
            div.textContent = day.info[infoKey];
            td.append(div);
          }
          tr.append(td);
        }

        if (day.day.getDay() == 6){
          tbody.append(tr);
        }
      }
      thead.append(trInthead);
      document.querySelector('#cal').append(table);
    }

    
  }




  function render(el,dateString){


    let dt = new Date(dateString);
    let dates = new Array();
    //현재 월의 시작일이 일요일이 아닌경우 앞에 이전달의 요일을 추가
    let beforeMonth = new Date(dt.getFullYear(),dt.getMonth(),dt.getDate());
    // console.log('beforeMonth',beforeMonth.toLocaleDateString(), 'lastDate',beforeMonth.getLastDate())
    beforeMonth.setMonth(beforeMonth.getMonth()-1);//전달로 설정
    // console.log('beforeMonth',beforeMonth.toLocaleDateString(), 'lastDate',beforeMonth.getLastDate())

    //전달의 마지막 주의 첫 요일
    let firstDayOfBoforeMonth = new Date(beforeMonth.getFullYear(),beforeMonth.getMonth(),
      (beforeMonth.getLastDate() - beforeMonth.getLastDay()));
    // console.log('firstDayOfBoforeMonth',firstDayOfBoforeMonth.toLocaleDateString(),'firstday:',firstDayOfBoforeMonth.getDay())
    //캘린더 중 전달 정보를 저장
    for (let date = firstDayOfBoforeMonth.getDate(); date <= beforeMonth.getLastDate() ; date++) {
      let info = {
        week : 1,
        monthFlag : 'beforeMonth'
      };

      dates.push(new Day(new Date(beforeMonth.getFullYear(), beforeMonth.getMonth(), date),info));
    }
    // console.log('dates',dates);
    //캘린더 중 현재 달 정보를 저장
    for (let date = 1; date <= dt.getLastDate(); date++) {
      let currentDay = new Date(dt.getFullYear(), dt.getMonth(), date);
      let info = {
        week : currentDay.getWeek(),
        monthFlag : 'currentMonth'
      };


      dates.push(new Day(currentDay, info) );
      //마지막날이 토요일이 아닌경우 토요일까지만 다음달의 일자를 추가함
      if (date == dt.getLastDate() && dt.getLastDay() < 6){

        for (let dateOfNextMonth = 1; dateOfNextMonth <= 6 ; dateOfNextMonth++) {
          let nextMonth = new Date(dt.getFullYear(),dt.getMonth()+1, dateOfNextMonth);
          if (nextMonth.getDay() > dt.getLastDay() ){
            let info = {
              week : currentDay.getWeek(),
              monthFlag : 'nextMonth'
            };
            dates.push(new Day(new Date(nextMonth.getFullYear(), nextMonth.getMonth(), dateOfNextMonth),info));
          }
        }
      }
    }
    console.log('dates',dates);


  }



</script>
</html>